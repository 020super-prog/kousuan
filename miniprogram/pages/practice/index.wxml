<!--pages/practice/index.wxml-->
<view class="practice-container">
  <!-- 顶部信息栏 -->
  <view class="practice-header">
    <view class="progress-info">
      <text class="progress-text color-primary">{{currentIndex + 1}}/{{totalCount}}</text>
    </view>
    <view class="time-info">
      <t-icon name="time" size="32rpx" color="#FF6B35" />
      <text class="time-text color-secondary">{{formatTime(elapsedTime)}}</text>
    </view>
  </view>

  <!-- 题目展示区 -->
  <view class="question-display">
    <!-- 加载状态 -->
    <view wx:if="{{loading}}" class="loading-wrapper">
      <t-loading theme="circular" size="80rpx" />
      <text class="loading-text">正在生成题目...</text>
    </view>

    <!-- 题目显示 -->
    <view wx:elif="{{currentQuestion}}" class="question-wrapper">
      <!-- 使用 displayQuestion（含 = ?），降级使用 expression 或 question -->
      <text class="question-text">
        {{currentQuestion.displayQuestion || (currentQuestion.expression + ' = ?') || (currentQuestion.question + ' = ?')}}
      </text>
      
      <!-- 用户答案显示 -->
      <view class="answer-display">
        <text class="answer-text" wx:if="{{userAnswer}}">{{userAnswer}}</text>
        <text class="answer-placeholder" wx:else>请输入答案</text>
      </view>
    </view>

    <!-- 错误状态 -->
    <view wx:else class="error-wrapper">
      <t-icon name="error-circle" size="80rpx" color="#E74C3C" />
      <text class="error-text">题目加载失败</text>
      <button class="retry-btn" bindtap="generateQuestionsFromCloud">重新生成</button>
    </view>
  </view>

  <!-- 答题反馈动画 -->
  <view class="feedback-animation {{feedbackType}}" wx:if="{{showFeedback}}">
    <view class="feedback-icon" wx:if="{{feedbackType === 'correct'}}">
      <t-icon name="check-circle" size="160rpx" color="#27AE60" />
      <text class="feedback-text">回答正确！</text>
    </view>
    <view class="feedback-icon" wx:else>
      <t-icon name="close-circle" size="160rpx" color="#E74C3C" />
      <text class="feedback-text">正确答案：{{currentQuestion.answer}}</text>
    </view>
  </view>

  <!-- 数字键盘 -->
  <view class="keyboard-wrapper">
    <view class="keyboard">
      <view class="keyboard-row">
        <view class="key-btn" wx:for="{{[1,2,3]}}" wx:key="*this" bindtap="inputNumber" data-num="{{item}}">
          {{item}}
        </view>
      </view>
      <view class="keyboard-row">
        <view class="key-btn" wx:for="{{[4,5,6]}}" wx:key="*this" bindtap="inputNumber" data-num="{{item}}">
          {{item}}
        </view>
      </view>
      <view class="keyboard-row">
        <view class="key-btn" wx:for="{{[7,8,9]}}" wx:key="*this" bindtap="inputNumber" data-num="{{item}}">
          {{item}}
        </view>
      </view>
      <view class="keyboard-row">
        <view class="key-btn key-delete" bindtap="deleteNumber">
          <t-icon name="backspace" size="48rpx" color="#FF6B35" />
        </view>
        <view class="key-btn" bindtap="inputNumber" data-num="0">0</view>
        <view class="key-btn key-confirm" bindtap="submitAnswer">
          <t-icon name="check" size="48rpx" color="#FFFFFF" />
        </view>
      </view>
    </view>
  </view>

  <!-- 进度条 -->
  <view class="progress-bar-wrapper">
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{progress}}%"></view>
    </view>
  </view>
</view>

<t-message id="t-message" />
